<!-- Copyright by the Spark Development Network; Licensed under the Rock Community License -->
<template>
    <NotificationBox v-if="blockErrorMessage" :alertType="AlertType.Warning">
        {{ blockErrorMessage }}
    </NotificationBox>

    <Panel v-if="!blockErrorMessage"
           type="block"
           :title="panelTitle"
           :class="panelCssClass"
           :hasFullscreen="true"
           :headerSecondaryActions="secondaryActions">

        <template #headerActions>
            <span class="action">
                <i class="fa fa-star-o"></i>
            </span>

            <span class="action">
                <i class="fa fa-list"></i>
            </span>

            <span class="action">
                <i class="fa fa-plus-square"></i>
            </span>
        </template>

        <template #preBody>
            <Toolbar :connectionTypes="connectionTypes"
                     :filterOptions="filterOptions"
                     :filters="filters"
                     :disabled="isBoardDisabled"
                     @opportunityChanged="onOpportunityChanged"
                     @filtersChanged="onFiltersChanged" />
        </template>

        <!-- Body -->
        <div v-if="!connectionOpportunity" class="panel-body-alert">

            <NotificationBox :alertType="AlertType.Info">
                Please select a connection opportunity.
            </NotificationBox>

        </div>

        <template v-else>
            <CardView />
        </template>

    </Panel>
</template>

<script setup lang="ts">
    import { computed, Ref, ref } from "vue";
    import CardView from "./ConnectionRequestBoard/cardView.partial.obs";
    import GridView from "./ConnectionRequestBoard/gridView.partial.obs";
    import Toolbar from "./ConnectionRequestBoard/toolbar.partial.obs";
    import { PageParameterKey } from "./ConnectionRequestBoard/types.partial";
    import NotificationBox from "@Obsidian/Controls/notificationBox.obs";
    import Panel from "@Obsidian/Controls/panel.obs";
    import { AlertType } from "@Obsidian/Enums/Controls/alertType";
    import { PanelAction } from "@Obsidian/Types/Controls/panelAction";
    import { onConfigurationValuesChanged, useConfigurationValues, useInvokeBlockAction, useReloadBlock } from "@Obsidian/Utility/block";
    import { syncRefsWithQueryParams } from "@Obsidian/Utility/url";
    import { ConnectionRequestBoardConnectionOpportunityBag } from "@Obsidian/ViewModels/Blocks/Connection/ConnectionRequestBoard/connectionRequestBoardConnectionOpportunityBag";
    import { ConnectionRequestBoardConnectionTypeBag } from "@Obsidian/ViewModels/Blocks/Connection/ConnectionRequestBoard/connectionRequestBoardConnectionTypeBag";
    import { ConnectionRequestBoardFilterOptionsBag } from "@Obsidian/ViewModels/Blocks/Connection/ConnectionRequestBoard/connectionRequestBoardFilterOptionsBag";
    import { ConnectionRequestBoardFiltersBag } from "@Obsidian/ViewModels/Blocks/Connection/ConnectionRequestBoard/connectionRequestBoardFiltersBag";
    import { ConnectionRequestBoardInitializationBox } from "@Obsidian/ViewModels/Blocks/Connection/ConnectionRequestBoard/connectionRequestBoardInitializationBox";
    import { ConnectionRequestBoardSelectedOpportunityBag } from "@Obsidian/ViewModels/Blocks/Connection/ConnectionRequestBoard/connectionRequestBoardSelectedOpportunityBag";

    const config = useConfigurationValues<ConnectionRequestBoardInitializationBox>();
    const invokeBlockAction = useInvokeBlockAction();
    const reloadBlock = useReloadBlock();

    const secondaryActions: PanelAction[] = [
        {
            title: "Campaign Requests",
            iconCssClass: "fas fa-user-plus",
            type: "default",
            handler: () => alert("Campaign Requests selected.")
        }
    ];

    // #region Values

    const connectionTypes = ref<ConnectionRequestBoardConnectionTypeBag[] | null | undefined>(config.connectionTypes);
    const selectedOpportunity = ref<ConnectionRequestBoardSelectedOpportunityBag | null | undefined>(config.selectedOpportunity);

    const blockActionErrorMessage = ref("");
    const isSelectingOpportunity = ref(false);

    // #endregion

    // #region Computed Values

    const blockErrorMessage = computed((): string | undefined | null => {
        return config.errorMessage;
    });

    const panelCssClass = computed((): string => {
        let cssClass = "styled-scroll";

        // if (isBoardView) {
        cssClass = `${cssClass} connection-board-view`;
        // }

        return cssClass;
    });

    const connectionRequestId = computed((): number | null | undefined => {
        return selectedOpportunity.value?.connectionRequestId;
    });

    const connectionOpportunity = computed((): ConnectionRequestBoardConnectionOpportunityBag | null | undefined => {
        return selectedOpportunity.value?.connectionOpportunity;
    });

    const connectionOpportunityId = computed((): number | null | undefined => {
        return connectionOpportunity.value?.id;
    });

    const panelTitle = computed((): string => {
        return connectionOpportunity.value?.publicName ?? "";
    });

    const filterOptions = computed((): ConnectionRequestBoardFilterOptionsBag | null | undefined => {
        return selectedOpportunity.value?.filterOptions;
    });

    const filters = computed((): ConnectionRequestBoardFiltersBag | null | undefined => {
        return selectedOpportunity.value?.filters;
    });

    const campusId = computed((): number | null | undefined => {
        return filters.value?.campusId;
    });

    const queryParamRefs = computed((): Record<string, Ref> => {
        return {
            [PageParameterKey.CampusId]: campusId,
            [PageParameterKey.ConnectionOpportunityId]: connectionOpportunityId,
            [PageParameterKey.ConnectionRequestId]: connectionRequestId
        };
    });

    const isBoardDisabled = computed((): boolean => {
        return !connectionOpportunity.value
            || isSelectingOpportunity.value;
    });

    // #endregion

    // #region Event Handlers

    /**
     * Handles the `opportunityChanged` event of the Toolbar component.
     *
     * @param connectionOpportunityId The identifier of the selected connection opportunity.
     */
    async function onOpportunityChanged(connectionOpportunityId: number): Promise<void> {
        isSelectingOpportunity.value = true;
        blockActionErrorMessage.value = "";

        const result = await invokeBlockAction<ConnectionRequestBoardSelectedOpportunityBag>("SelectConnectionOpportunity", { connectionOpportunityId });
        isSelectingOpportunity.value = false;

        if (!result.isSuccess) {
            blockActionErrorMessage.value = result.errorMessage || "Unknown error while trying to select connection opportunity.";
            return;
        }

        selectedOpportunity.value = result.data ?? null;
    }

    /**
     * Handles the `filtersChanged` event of the Toolbar component.
     *
     * @param filters The selected filters.
     */
    async function onFiltersChanged(filters: ConnectionRequestBoardFiltersBag): Promise<void> {
        console.log(JSON.stringify(filters));
    }

    // #endregion

    onConfigurationValuesChanged(reloadBlock);

    syncRefsWithQueryParams(queryParamRefs.value);
</script>
